<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity App Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Workify</h1>
            <p>Configure your focus session settings</p>
        </div>
        <!-- Tab Navigation -->
        <div style="background: #f1f3f6; border-bottom: 1px solid #e9ecef; display: flex;">
            <button class="tab-btn" id="configTabBtn" onclick="showTab('config')">Configuration</button>
            <button class="tab-btn" id="diaryTabBtn" onclick="showTab('diary')">Diary Entries</button>
            <button class="tab-btn" id="calendarTabBtn" onclick="showTab('calendar')">Statistics</button>
        </div>
        <div class="content">
            {% if message %}
                <div class="alert alert-{{ message_type }}">
                    {{ message }}
                </div>
            {% endif %}
            <!-- Configuration Tab -->
            <div id="configTab" class="tab-content">
                <form method="POST" action="/update-config" class="config-form">
                    <!-- Timer Settings -->
                    <div class="section">
                                <h2 class="section-title">Timer Settings</h2>
                        <div class="form-group">
                            <label for="default_duration_minutes">Default Session Duration (minutes)</label>
                            <div>
                                <input type="number" id="default_duration_minutes" name="default_duration_minutes" 
                                       value="{{ config.default_duration_minutes }}" min="1" max="120" required>
                                <div class="description">How long should a standard focus session last?</div>
                            </div>
                        </div>
                    </div>
                    <!-- AI Detection Settings -->
                    <div class="section">
                        <h2 class="section-title">AI Detection Settings</h2>
                        <div class="form-group">
                            <label for="confidence_threshold">Confidence Threshold</label>
                            <div>
                                <input type="number" id="confidence_threshold" name="confidence_threshold" 
                                       value="{{ config.confidence_threshold }}" min="0.1" max="1.0" step="0.05" required>
                                <div class="description">Minimum confidence for person detection (0.1 - 1.0)</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="nms_confidence_threshold">NMS Confidence Threshold</label>
                            <div>
                                <input type="number" id="nms_confidence_threshold" name="nms_confidence_threshold" 
                                       value="{{ config.nms_confidence_threshold }}" min="0.1" max="1.0" step="0.05" required>
                                <div class="description">Non-maximum suppression confidence threshold</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="nms_iou_threshold">NMS IoU Threshold</label>
                            <div>
                                <input type="number" id="nms_iou_threshold" name="nms_iou_threshold" 
                                       value="{{ config.nms_iou_threshold }}" min="0.1" max="1.0" step="0.05" required>
                                <div class="description">Non-maximum suppression IoU threshold</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="input_width">Input Width (pixels)</label>
                            <div>
                                <input type="number" id="input_width" name="input_width" 
                                       value="{{ config.input_width }}" min="320" max="1024" step="32" required>
                                <div class="description">YOLO model input width (lower = faster processing)</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="input_height">Input Height (pixels)</label>
                            <div>
                                <input type="number" id="input_height" name="input_height" 
                                       value="{{ config.input_height }}" min="320" max="1024" step="32" required>
                                <div class="description">YOLO model input height (lower = faster processing)</div>
                            </div>
                        </div>
                    </div>
                    <!-- Audio Settings -->
                    <div class="section">
                        <h2 class="section-title">Audio Settings</h2>
                        <div class="form-group">
                            <label for="alarm_sound_file">Alarm Sound File</label>
                            <div>
                                <input type="text" id="alarm_sound_file" name="alarm_sound_file" 
                                       value="{{ config.alarm_sound_file }}" required>
                                <div class="description">Audio file to play during focus sessions</div>
                            </div>
                        </div>
                    </div>
                    <!-- Notification Settings -->
                    <div class="section">
                        <h2 class="section-title">Notification Settings</h2>
                        <div class="form-group">
                            <label for="show_countdown">Show Countdown Timer</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="show_countdown" name="show_countdown" 
                                       {% if config.show_countdown %}checked{% endif %}>
                                <div class="description">Display countdown notifications during sessions</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="countdown_update_interval">Countdown Update Interval (seconds)</label>
                            <div>
                                <input type="number" id="countdown_update_interval" name="countdown_update_interval" 
                                       value="{{ config.countdown_update_interval }}" min="1" max="300" required>
                                <div class="description">How often to update countdown notifications</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ask_diary_entry">Ask for Diary Entry</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="ask_diary_entry" name="ask_diary_entry" 
                                       {% if config.ask_diary_entry %}checked{% endif %}>
                                <div class="description">Prompt for diary entry after focus sessions</div>
                            </div>
                        </div>
                    </div>
                    <div class="btn-container">
                        <button type="submit" class="btn-primary">ðŸ’¾ Save Configuration</button>
                    </div>
                </form>
            </div>
            <!-- Diary Entries Tab -->
            <div id="diaryTab" class="tab-content" style="display:none;">
                <div class="section" id="diaries">
                    
                </div>
            </div>
            <!-- Statistics Tab -->
            <div id="calendarTab" class="tab-content" style="display:none;">
                <div class="section" id="calendar-view">
                        <h2 class="section-title">Calendar Activity</h2>
                        <div id="calendar-heatmap"></div>
                        <div style="margin-top:10px; color:#888; font-size:0.95rem;">Darker squares = more diary entries that day</div>
                </div>
                <div class="section" id="calendar-stats">
                    <h2 class="section-title">Statistics</h2>
                    <div class="stat-row">
                        <div><b>Total Focus Time:</b> {{ total_focus_minutes }} minutes</div>
                    </div>
                    <div class="stat-row">
                        <div><b>Total Break Time:</b> {{ total_break_minutes }} minutes</div>
                    </div>
                    <div class="stat-row">
                        <div><b>Number of Diary Entries:</b> {{ diary_entries|length }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Tab switching logic
        function showTab(tab) {
            document.getElementById('configTab').style.display = (tab === 'config') ? '' : 'none';
            document.getElementById('diaryTab').style.display = (tab === 'diary') ? '' : 'none';
            document.getElementById('calendarTab').style.display = (tab === 'calendar') ? '' : 'none';
            document.getElementById('configTabBtn').style.background = (tab === 'config') ? '#fff' : '';
            document.getElementById('diaryTabBtn').style.background = (tab === 'diary') ? '#fff' : '';
            document.getElementById('calendarTabBtn').style.background = (tab === 'calendar') ? '#fff' : '';
        }
        showTab('config');
    </script>
        <script>
        // Github thingy
        const diaryEntries = {{ diary_entries|tojson }};
        const entryCountByDay = {};
        diaryEntries.forEach(entry => {
            const day = entry.date.substring(0, 10);
            entryCountByDay[day] = (entryCountByDay[day] || 0) + 1;
        });

        function getLastNDates(n) {
            const dates = [];
            const today = new Date();
            for (let i = n - 1; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const dateStr = d.toISOString().slice(0, 10);
                dates.push(dateStr);
            }
            return dates;
        }

        function colorGradient (colorMin, colorMax, interp) {
            const r = Math.round(colorMin[0] + interp * (colorMax[0] - colorMin[0]));
            const g = Math.round(colorMin[1] + interp * (colorMax[1] - colorMin[1]));
            const b = Math.round(colorMin[2] + interp * (colorMax[2] - colorMin[2]));
            return `rgb(${r}, ${g}, ${b})`;
        }

        function renderCalendarHeatmap() {
            const columns = 40;
            const rows = 12;
            const container = document.getElementById('calendar-heatmap');
            container.innerHTML = '';
            const allDates = getLastNDates(columns * rows);

            //Calculate the maximum
            let maxcount = 0;
            for (let row=0; row < rows; row++) {
                for (let col=0; col < columns; col++) {
                    const idx = col * rows + row;
                    if (idx >= allDates.length) break;
                    const dateStr = allDates[idx];
                    const count = entryCountByDay[dateStr] || 0;
                    if (count > maxcount) maxcount = count;
                }
            }
            
            //Draw it
            for (let row = 0; row < rows; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.style.display = 'flex';
                rowDiv.style.alignItems = 'center';
                rowDiv.style.marginBottom = '2px';
                for (let col = 0; col < columns; col++) {
                    const idx = col * rows + row;
                    if (idx >= allDates.length) break;
                    const dateStr = allDates[idx];
                    const count = entryCountByDay[dateStr] || 0;
                    color = colorGradient([233,236,239], [0,0,0], count / maxcount);
                    const square = document.createElement('div');
                    square.title = `${dateStr}: ${count} entr${count === 1 ? 'y' : 'ies'}`;
                    square.style.width = '18px';
                    square.style.height = '18px';
                    square.style.margin = '0 1px';
                    square.style.background = color;
                    square.style.borderRadius = '3px';
                    square.style.border = '1px solid #e9ecef';
                    rowDiv.appendChild(square);
                }
                container.appendChild(rowDiv);
            }
        }
        document.getElementById('calendarTabBtn').addEventListener('click', renderCalendarHeatmap);
        </script>
    <script>

    // Diary Entries Tab rendering
    const uniqueDates = [...new Set(diaryEntries.map(entry => entry.date.substring(0, 10)))];
    const diaryEntriesByDate = uniqueDates.map(date => {
        return {
            date: date,
            entries: diaryEntries.filter(entry => entry.date.substring(0, 10) === date)
        };
    });
    const diariesContainer = document.getElementById('diaries');
    diaryEntriesByDate.forEach(element => {
        diariesContainer.innerHTML += `
            <h2 class="section-title">${element.date}</h2>
            ${element.entries.length > 0 ? `
                <ul style="list-style:none; padding:0;">
                    ${element.entries.map(entry => `
                        <li style="margin-bottom: 18px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                            <div style="font-size:1.1rem; color:#333; margin-bottom:6px;"><b>${entry.date.substring(10,entry.date.length)}</b></div>
                            <div style="color:#555;">${entry.text}</div>
                        </li>
                    `).join('')}
                </ul>
            ` : '<div style="color:#888; font-style:italic;">No diary entries found.</div>'}
        `;
    });
</script>
</body>
</html>
